{% extends "base/base.html" %}


{% block js %}
<script src="{{ url_for('static', filename='focus2/js/images_upload.js') }}"></script>
{% endblock %}


{% macro file_select(field, is_required=False) -%}
<div class='control-group{% if field.errors %} error{% endif %}'>
  <label class='control-label' for='{{ field.label.field_id }}'>
    {% if is_required %}
    <b>{{ field.label.text }}</b>
    {% else %}
    {{ field.label.text }}
    {% endif %}
  </label>
  <div class='controls'>
    <input id='{{ field.label.field_id }}'
           name='{{ field.name }}'
           type='{{ field.widget.input_type }}'
           value='{{ field.data or "" }}'
           placeholder="URL to image"
           ng-model="form.{{ field.name }}"
           ng-readonly="form.{{ field.name }}.indexOf('file') == 0"
           >
    </input>

    <input class="hide"
           id="file_{{ field.name }}"
           type="file"
           ng-model="form.file_{{ field.name }}"></input>
    <a id="btn_{{ field.name }}"
       class="btn"
       href="javascript:void(0)"
       style="position: relative; z-index: 0;"
       ng-click="file_select('{{field.name}}')">URL</a>
  </div>
</div>
{%- endmacro %}

{% block content %}
  {% from 'base/macros.html' import input_horizontal %}
  {% from 'base/macros.html' import select_horizontal %}
  {% from 'base/macros.html' import radio_horizontal %}

  <script>
    window.data = {{ data|tojson|safe }};
  </script>

  <div class='container' ng-app='instances_spawn'>
    <div class='row' ng-controller='SpawnController'>
      <div class='span6'>
        <form method="GET" action=".">
          <input id="open_file_dialog" type="file">
        </form>
        <form action="." class="form-horizontal well ng-pristine ng-valid"
              method="POST">
          <fieldset>
            {{ select_horizontal(
                 form.project,
                 data=data, is_required=False,
                 data_placeholder='Select Project')
            }}
            {{ radio_horizontal(form.image_type) }}
            {{ input_horizontal(form.name, is_required=True) }}

            <div ng-show="form.image_type == 'solid'">
              {{ file_select(form.solid_image, is_required=True) }}
              {{ radio_horizontal(form.disk_format) }}
            </div>
            <div ng-show="form.image_type == 'amazon_like'">
              {{ select_horizontal(
                   form.kernel,
                   data=data, is_required=True)
              }}
              {{ select_horizontal(
                   form.initrd,
                   data=data, is_required=True)
              }}
              {{ input_horizontal(form.filesystem, is_required=True) }}
            </div>
            
            <div class="form-actions">
              <button class="btn btn-primary" type="submit">Register</button>
              <a class="btn" href="javascript: history.back();">Cancel</a>
            </div>
        </fieldset>
      </form>
    </div>

    <div class='span6'>
    </div>
  </div>
</div>
{% endblock %}


<!DOCTYPE html>
<html>
<head>
    <title>Upload Files using XMLHttpRequest - Minimal</title>

    <script type="text/javascript">
      function fileSelected() {
        var file = document.getElementById('fileToUpload').files[0];
        if (file) {
          var fileSize = 0;
          if (file.size > 1024 * 1024)
            fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
          else
            fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';

          document.getElementById('fileName').innerHTML = 'Name: ' + file.name;
          document.getElementById('fileSize').innerHTML = 'Size: ' + fileSize;
          document.getElementById('fileType').innerHTML = 'Type: ' + file.type;
        }
      }

      function uploadFile() {
        var fd = new FormData();
        fd.append("fileToUpload", document.getElementById('fileToUpload').files[0]);
        var xhr = new XMLHttpRequest();
        xhr.upload.addEventListener("progress", uploadProgress, false);
        xhr.addEventListener("load", uploadComplete, false);
        xhr.addEventListener("error", uploadFailed, false);
        xhr.addEventListener("abort", uploadCanceled, false);
        xhr.open("POST", "http://localhost:8282/images/upload/?name=hello&field=bye");
        xhr.send(fd);
      }

      function uploadProgress(evt) {
        if (evt.lengthComputable) {
          var percentComplete = Math.round(evt.loaded * 100 / evt.total);
          document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
        }
        else {
          document.getElementById('progressNumber').innerHTML = 'unable to compute';
        }
      }

      function uploadComplete(evt) {
        /* This event is raised when the server send back a response */
        alert(evt.target.responseText);
      }

      function uploadFailed(evt) {
        alert("There was an error attempting to upload the file.");
      }

      function uploadCanceled(evt) {
        alert("The upload has been canceled by the user or the browser dropped the connection.");
      }
    </script>
</head>
<body>
  <form id="form1" enctype="multipart/form-data" method="post" action="http://localhost:8282/images/upload/">
    <div class="row">
      <label for="fileToUpload">Select a File to Upload</label><br />
      <input type="file" name="fileToUpload" id="fileToUpload" onchange="fileSelected();"/>
    </div>
    <div id="fileName"></div>
    <div id="fileSize"></div>
    <div id="fileType"></div>
    <div class="row">
      <input type="button" onclick="uploadFile()" value="Upload" />
    </div>
    <div id="progressNumber"></div>
  </form>
</body>
</html>
