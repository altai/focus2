{% extends "base/base.html" %}


{% block body_attrs %}
  ng-app='projects_audit'
{% endblock %}


{% block css %}
  <link href="{{ url_for('static', filename='deps/daterangepicker/daterangepicker.css') }}" rel='stylesheet' type='text/css'>
{% endblock %}


{% block js %}
  <script src="{{ url_for('static', filename='deps/date.js') }}"></script>
  <script src="{{ url_for('static', filename='deps/daterangepicker/daterangepicker.js') }}"></script>
  <script src="{{ url_for('static', filename='deps/angular/angular-resource.min.js') }}"></script>
  <script src="{{ url_for('static', filename='focus2/js/projects_audit.js') }}" type='text/javascript'></script>
{% endblock %}


{% block content %}
  {% from "base/macros.html" import search_pagination %}

  <div class='container'>
    <div ng-view>
    </div>
  </div>

  <script type="text/ng-template" id="partials/search.html">
    <div class="row spaceup">
      <div class="span12">
        <form class="form-inline form" method="GET" action="{{ request.url }}">
          <div class="input-prepend">
            <span class="add-on"><i class="icon-calendar"></i></span>
            <input type="text" class="daterange" ng-model="date_range" id="date_range"/>
          </div>
          <div class="input-append">
            <input type="text" class="span2 search" ng-model="query"/>
            <a class="btn" ng-click="update_location()">Search</a>
          </div>
          {% raw %}
            <span>Page size:</span>
            <select style="width: auto" ng-model="perPage" ng-change="update_location()">
              <option ng-repeat="x in per_page_choices">{{ x }}</option>
            </select>
          {% endraw %}

          <div class="accordion-group">
            <div class="accordion-heading">
              <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
                Users:
                {% raw %}
                  {{ users.join(", ") || "all" }}
                {% endraw %}
              </a>
            </div>
            <div id="collapseOne" class="accordion-body collapse">
              <div class="accordion-inner">
                <select ui-select2 multiple data-placeholder="Users" ng-model="users">
                  {% for user in data["users"] %}
                  <option>{{ user["name"] }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <table class="table table-striped table-bordered table-condensed" style="margin-top: 5px;">
    <thead>
      <tr>
        <th>
          When
        </th>
        <th>
          What
        </th>
        <th>
          Who
        </th>
      </tr>
    </thead>
    <tbody>
      <tr ng-hide="search.data.length > 0">
        <td colspan="4">No data to show</td>
      </tr>
      {% raw %}
      <tr ng-repeat="obj in search.data">
        <td>
          {{ obj["timestamp"] | date:"dd/MM/yyyy HH:mm:ss" }}
        </td>
        <td>
          {{ obj["method"] }} {{ obj["resource"] }} {{ obj["response_status"] }}
        </td>
        <td>
          <a href='{% endraw %}{{ url_for("projects.members_show", id="") }}{% raw %}{{ obj["user"]["id"] }}'>
            {{ obj["user"]["name"] }}
          </a>
        </td>
      </tr>
      {% endraw %}
    </tbody>
  </table>

{{ search_pagination() }}

</script>
{% endblock %}

